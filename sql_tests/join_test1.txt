SET sql_mode = '', @START_TIME:=; 
SELECT PAY.ID, SER.ID, PAY.Data, 
SUM( case when PAY.Data <= STR_TO_DATE('2017-02-15', '%Y-%m-%d') and PAY.PAY_ID!=3 then PAY.Summa else 0 end) AS SummStart, 
SUM( case when PAY.Data >= STR_TO_DATE('2017-02-15', '%Y-%m-%d') and PAY.PAY_ID!=3 and PAY.Summa>=0 then PAY.Summa else 0 end) AS SummPlus, 
SUM( case when PAY.Data >= STR_TO_DATE('2017-02-15', '%Y-%m-%d') and PAY.PAY_ID!=3 and PAY.Summa<=0 then PAY.Summa else 0 end) AS SummMinus, 
SUM( case when PAY.Data >= STR_TO_DATE('2017-02-15', '%Y-%m-%d') and PAY.PAY_ID=3 then PAY.Summa else 0 end) AS SummPererasthet, 
SUM( case when PAY.Data >= STR_TO_DATE('2017-02-15', '%Y-%m-%d') and PAY.PAY_ID!=3 then PAY.Summa else 0 end) AS SummItogo, 
PAY.ACNT_ID 
FROM `Payments` PAY 
LEFT JOIN `Services` SER ON PAY.ACNT_ID = SER.ID 
GROUP BY SER.ID 
HAVING PAY.Data <= STR_TO_DATE('2017-03-15', '%Y-%m-%d')


$sql = "SELECT `Data`,
               `Name` as serviceName,
               @DataStart:=STR_TO_DATE('$data_start', '%Y-%m-%d'),
               @SUMMA_START:=SUM( case 
			                            when `Data` <=STR_TO_DATE('$data_start', '%Y-%m-%d')
                                            and	`PAY_ID` != 3		   
	                                    then `Summa` 
						                else 0 end
								   ) AS `Balans`, 
               @SUMMA_PLUS := SUM( case 
			                       when `Summa`>=0 
			                and `PAY_ID` != 3
			                and `Data` => STR_TO_DATE('$data_start', '%Y-%m-%d') 
	                    then `Summa` else 0 end
			      ) AS `Plus`, 
			    @SUMMA_MINUS := SUM(case 
			           when `Summa`<=0
                          and `PAY_ID` != 3					   
			              and `Data` => STR_TO_DATE('$data_start', '%Y-%m-%d')
					   then `Summa` else 0 end
				   ) AS `Minus`,
			    SUMMA_ITOGO = @SUMMA_PLUS + @SUMMA_MINUS AS `Itogo`,
			   `ACNT_ID` 			   
	    FROM `Payments` as PAY 
		JOIN `Services` as SER ON PAY.ID = SER.ID
		GROUP BY `ACNT_ID` 
		HAVING  `Data`<STR_TO_DATE('$data_end', '%Y-%m-%d');";
		
		
		
		$sql = "SELECT `Name` as serviceName,
               @SUMMA_START:=SUM( case when `Data` <= STR_TO_DATE('$data_start', '%Y-%m-%d') and `PAY_ID` != '3' then `Summa` else 0 end), 
               @SUMMA_PLUS:=SUM( case when `Summa`>=0 
			                and `PAY_ID` != '3'
			                and `Data` => STR_TO_DATE('$data_start', '%Y-%m-%d') 
	                    then `Summa` else 0 end), 
			    @SUMMA_MINUS:=SUM(case when `Summa`<=0
                          and `PAY_ID` != '3'					   
			              and `Data` => STR_TO_DATE('$data_start', '%Y-%m-%d')
					   then `Summa` else 0 end),
			    SUMMA_ITOGO = @SUMMA_PLUS + @SUMMA_MINUS,
			   `ACNT_ID` 			   
	    FROM `Payments` as PAY 
		JOIN `Services` as SER ON PAY.ID = SER.ID
		GROUP BY `ACNT_ID` 
		HAVING  `Data` <= STR_TO_DATE('$data_end', '%Y-%m-%d');";